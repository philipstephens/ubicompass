<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UBI Compass - Navigate UBI Policy with Data-Driven Analysis</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="/js/translations.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f3f4f6; /* Matches Tailwind's bg-gray-200 */
      }
      .header-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
      }
      .header {
        background-color: rgba(186, 164, 61, 1);
        color: white;
        padding: 20px;
        text-align: center;
        height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .menu-container {
        position: fixed;
        top: 150px; /* Height of header */
        left: 0;
        right: 0;
        z-index: 10;
      }
      .menu {
        background-color: rgb(255, 215, 0);
        color: rgb(255, 0, 0);
        padding: 5px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 40px;
      }
      .main-content {
        margin-top: 200px; /* Header + Menu height + some padding */
        padding-bottom: 40px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .card {
        border-radius: 24px;
        overflow: hidden;
        border: 1px solid #d0d6f7;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        margin-bottom: 20px;
      }
      .card-header {
        background-color: #9333ea; /* Matches Tailwind's bg-purple-600 */
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .card-title {
        font-weight: bold;
        font-size: 18px;
        margin: 0;
        color: white;
      }
      .card-content {
        padding: 20px;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      iframe {
        width: 100%;
        height: 1200px;
        border: none;
      }
      .calculator-iframe {
        width: 100%;
        height: 1200px;
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        background-color: white;
        margin-top: 20px;
      }
      .view-toggle {
        display: flex;
        gap: 12px;
        justify-content: flex-start;
      }
      .view-button {
        background-color: #673ab7;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .view-button:hover {
        background-color: #5e35b1;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      .view-button.active {
        background-color: #4527a0;
        box-shadow: 0 4px 8px rgba(69, 39, 160, 0.3);
      }
      #taxPercentageValue {
        font-weight: bold;
        color: #673ab7;
        margin-left: 5px;
      }
      .nav-link {
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        font-weight: 500;
        transition: all 0.2s;
      }
      .nav-link:hover {
        opacity: 0.9;
      }
      .nav-link.active {
        font-weight: bold;
      }
      .nav-purple {
        background-color: #9333ea;
        color: white;
      }
      .nav-blue {
        background-color: #2563eb;
        color: white;
      }
      .nav-green {
        background-color: #16a34a;
        color: white;
      }
      .nav-gray {
        background-color: #4b5563;
        color: white;
      }

      /* Controls styling */
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
      }
      .control-group {
        flex: 1;
        min-width: 200px;
      }
      .control-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .control-select {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
      }
      .control-range {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <div class="header">
        <h1 class="text-3xl font-bold" data-translate="UBI Compass">
          UBI Compass
        </h1>
        <p
          class="text-sm"
          data-translate="Navigate UBI Policy with Data-Driven Analysis"
        >
          Navigate UBI Policy with Data-Driven Analysis
        </p>
      </div>
    </div>

    <div class="menu-container">
      <div class="menu">
        <div class="flex space-x-4">
          <a
            href="/"
            class="text-red-700 hover:text-red-900"
            data-translate="Home"
            >Home</a
          >
          <a
            href="/standalone-app.html"
            class="text-red-700 hover:text-red-900 font-bold"
            data-translate="UBI Compass"
            >UBI Compass</a
          >
          <a
            href="/simple"
            class="text-red-700 hover:text-red-900"
            data-translate="Simple Version"
            >Simple Version</a
          >
        </div>
        <div>
          <select
            class="bg-yellow-200 text-red-700 p-1 rounded"
            id="languageSelector"
          >
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
          </select>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="container">
        <div class="bg-white shadow-md rounded-lg p-4 mb-4">
          <h1
            class="text-2xl font-bold mb-2"
            data-translate="UBI Compass Policy Analysis Tool"
          >
            UBI Compass Policy Analysis Tool
          </h1>
          <p
            class="mb-4"
            data-translate="Navigate Universal Basic Income policy decisions with comprehensive data analysis. Explore income distribution impacts, feasibility metrics, and cost analysis across different income groups. Switch between quintile view (5 groups) and decile view (10 groups) for detailed policy insights."
          >
            Navigate Universal Basic Income policy decisions with comprehensive
            data analysis. Explore income distribution impacts, feasibility
            metrics, and cost analysis across different income groups. Switch
            between quintile view (5 groups) and decile view (10 groups) for
            detailed policy insights.
          </p>
          <div class="flex flex-wrap gap-4">
            <button
              id="quintileBtn"
              class="nav-link nav-purple"
              data-translate="Quintile Calculator"
            >
              Quintile Calculator
            </button>
            <button
              id="decileBtn"
              class="nav-link nav-blue active"
              data-translate="Decile Calculator with SVG Charts"
            >
              Decile Calculator with SVG Charts
            </button>
            <a
              href="/"
              class="nav-link nav-gray"
              data-translate="Back to Main App"
            >
              Back to Main App
            </a>
          </div>
        </div>

        <!-- Calculator Parameters -->
        <div class="card">
          <div class="card-header">
            <h2
              class="card-title"
              data-translate="UBI Compass Analysis Parameters"
            >
              UBI Compass Analysis Parameters
            </h2>
          </div>
          <div class="card-content">
            <div class="controls">
              <div class="control-group">
                <label class="control-label" data-translate="Tax Year"
                  >Tax Year</label
                >
                <select id="taxYear" class="control-select">
                  <!-- Options will be populated dynamically from database -->
                </select>
              </div>

              <div class="control-group">
                <label class="control-label" data-translate="UBI Amount"
                  >UBI Amount</label
                >
                <select id="ubiAmount" class="control-select">
                  <option
                    value="12"
                    data-translate="$12k / Year ($1.0k / month)"
                  >
                    $12k / Year ($1.0k / month)
                  </option>
                  <option
                    value="18"
                    data-translate="$18k / Year ($1.5k / month)"
                  >
                    $18k / Year ($1.5k / month)
                  </option>
                  <option
                    value="24"
                    selected
                    data-translate="$24k / Year ($2.0k / month)"
                  >
                    $24k / Year ($2.0k / month)
                  </option>
                  <option
                    value="30"
                    data-translate="$30k / Year ($2.5k / month)"
                  >
                    $30k / Year ($2.5k / month)
                  </option>
                  <option
                    value="36"
                    data-translate="$36k / Year ($3.0k / month)"
                  >
                    $36k / Year ($3.0k / month)
                  </option>
                </select>
              </div>

              <div class="control-group">
                <label
                  class="control-label"
                  data-translate="Flat Tax Percentage"
                  >Flat Tax Percentage:
                  <span id="taxPercentageValue">30%</span></label
                >
                <input
                  type="range"
                  id="taxPercentage"
                  class="control-range"
                  min="1"
                  max="99"
                  value="30"
                />
              </div>

              <div class="control-group">
                <label class="control-label" data-translate="Exemption Amount"
                  >Exemption Amount</label
                >
                <select id="exemptionAmount" class="control-select">
                  <option value="0" data-translate="$0k (No exemption)">
                    $0k (No exemption)
                  </option>
                  <option
                    value="12"
                    data-translate="$12k (No tax on first $12k)"
                  >
                    $12k (No tax on first $12k)
                  </option>
                  <option
                    value="18"
                    data-translate="$18k (No tax on first $18k)"
                  >
                    $18k (No tax on first $18k)
                  </option>
                  <option
                    value="24"
                    selected
                    data-translate="$24k (No tax on first $24k)"
                  >
                    $24k (No tax on first $24k)
                  </option>
                  <option
                    value="30"
                    data-translate="$30k (No tax on first $30k)"
                  >
                    $30k (No tax on first $30k)
                  </option>
                  <option
                    value="36"
                    data-translate="$36k (No tax on first $36k)"
                  >
                    $36k (No tax on first $36k)
                  </option>
                </select>
              </div>

              <div class="control-group">
                <label class="control-label" data-translate="Child UBI Amount"
                  >Child UBI Amount (Monthly)</label
                >
                <select id="childUbiAmount" class="control-select">
                  <option value="0" data-translate="$0/month (No child UBI)">
                    $0/month (No child UBI)
                  </option>
                  <option value="50" data-translate="$50/month ($600/year)">
                    $50/month ($600/year)
                  </option>
                  <option value="100" data-translate="$100/month ($1.2k/year)">
                    $100/month ($1.2k/year)
                  </option>
                  <option
                    value="200"
                    selected
                    data-translate="$200/month ($2.4k/year)"
                  >
                    $200/month ($2.4k/year)
                  </option>
                  <option value="300" data-translate="$300/month ($3.6k/year)">
                    $300/month ($3.6k/year)
                  </option>
                  <option value="500" data-translate="$500/month ($6.0k/year)">
                    $500/month ($6.0k/year)
                  </option>
                  <option value="750" data-translate="$750/month ($9.0k/year)">
                    $750/month ($9.0k/year)
                  </option>
                </select>
              </div>

              <!-- Chart View Toggle Buttons -->
              <div class="control-group">
                <label class="control-label" data-translate="Chart View"
                  >Chart View</label
                >
                <div class="view-toggle">
                  <button
                    id="incomeViewBtn"
                    class="view-button active"
                    data-translate="Income Impact"
                  >
                    Income Impact
                  </button>
                  <button
                    id="costViewBtn"
                    class="view-button"
                    data-translate="Cost Analysis"
                  >
                    Cost Analysis
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="quintileContent" class="tab-content">
          <!-- No wrapper card - iframe content has its own styling -->
          <iframe
            src="/fixed-chart.html"
            id="quintileIframe"
            class="calculator-iframe"
          ></iframe>
        </div>

        <div id="decileContent" class="tab-content active">
          <!-- No wrapper card - iframe content has its own styling -->
          <iframe
            src="/decile-calculator-svg-demo.html"
            id="decileIframe"
            class="calculator-iframe"
          ></iframe>
        </div>
      </div>
    </div>

    <script>
      // DOM Elements
      const quintileBtn = document.getElementById("quintileBtn");
      const decileBtn = document.getElementById("decileBtn");
      const quintileContent = document.getElementById("quintileContent");
      const decileContent = document.getElementById("decileContent");
      const languageSelector = document.getElementById("languageSelector");
      const taxYear = document.getElementById("taxYear");
      const ubiAmount = document.getElementById("ubiAmount");
      const taxPercentage = document.getElementById("taxPercentage");
      const taxPercentageValue = document.getElementById("taxPercentageValue");
      const exemptionAmount = document.getElementById("exemptionAmount");
      const quintileIframe = document.getElementById("quintileIframe");
      const decileIframe = document.getElementById("decileIframe");
      const incomeViewBtn = document.getElementById("incomeViewBtn");
      const costViewBtn = document.getElementById("costViewBtn");

      // Load available years from API
      async function loadAvailableYears() {
        try {
          const response = await fetch("/api/years");
          const data = await response.json();

          if (response.ok) {
            console.log("Available years:", data.years);
            return data.years;
          } else {
            console.error("API Error:", data.error);
            return [2000, 2022]; // Fallback years
          }
        } catch (error) {
          console.error("Failed to load available years:", error);
          return [2000, 2022]; // Fallback years
        }
      }

      // Populate year dropdown with available years
      async function populateYearDropdown() {
        try {
          console.log("Loading available years for main app...");
          const availableYears = await loadAvailableYears();
          console.log("Available years loaded:", availableYears);

          // Clear existing options
          taxYear.innerHTML = "";

          // Add available years as options
          availableYears.forEach((year) => {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            taxYear.appendChild(option);
            console.log(`Added year option: ${year}`);
          });

          // Set the most recent year as default
          if (availableYears.length > 0) {
            const latestYear = Math.max(...availableYears);
            taxYear.value = latestYear;
            console.log(`Set default year to: ${latestYear}`);
            return latestYear;
          }

          return 2000; // Fallback
        } catch (error) {
          console.error("Failed to populate year dropdown:", error);
          return 2000; // Fallback
        }
      }

      // Tab switching functionality
      quintileBtn.addEventListener("click", () => {
        quintileContent.classList.add("active");
        decileContent.classList.remove("active");
        quintileBtn.classList.add("active");
        quintileBtn.classList.add("nav-purple");
        decileBtn.classList.remove("active");
        decileBtn.classList.add("nav-blue");
      });

      decileBtn.addEventListener("click", () => {
        decileContent.classList.add("active");
        quintileContent.classList.remove("active");
        decileBtn.classList.add("active");
        decileBtn.classList.add("nav-blue");
        quintileBtn.classList.remove("active");
        quintileBtn.classList.add("nav-purple");
      });

      // Update tax percentage value display
      taxPercentage.addEventListener("input", () => {
        console.log("Tax percentage changed to:", taxPercentage.value);
        taxPercentageValue.textContent = `${taxPercentage.value}%`;
        console.log("Updated display to:", taxPercentageValue.textContent);
        updateCalculators();
      });

      // Initialize the percentage display on page load
      function initializePercentageDisplay() {
        if (taxPercentage && taxPercentageValue) {
          taxPercentageValue.textContent = `${taxPercentage.value}%`;
          console.log(
            "Initialized percentage display to:",
            taxPercentageValue.textContent
          );
        } else {
          console.error("Could not find tax percentage elements:", {
            taxPercentage: !!taxPercentage,
            taxPercentageValue: !!taxPercentageValue,
          });
        }
      }

      // Simple translation function (placeholder)
      function applyTranslations(language) {
        console.log("Applying translations for language:", language);
        // For now, this is a placeholder function
        // The actual translation would happen here
        // We don't want to overwrite the percentage display
      }

      // Chart view toggle functionality
      incomeViewBtn.addEventListener("click", () => {
        incomeViewBtn.classList.add("active");
        costViewBtn.classList.remove("active");
        // Send message to iframe to switch to income view
        if (decileIframe && decileIframe.contentWindow) {
          decileIframe.contentWindow.postMessage(
            { action: "showIncomeView" },
            "*"
          );
        }
      });

      costViewBtn.addEventListener("click", () => {
        costViewBtn.classList.add("active");
        incomeViewBtn.classList.remove("active");
        // Send message to iframe to switch to cost view
        if (decileIframe && decileIframe.contentWindow) {
          decileIframe.contentWindow.postMessage(
            { action: "showCostView" },
            "*"
          );
        }
      });

      // Update calculators when parameters change
      taxYear.addEventListener("change", updateCalculators);
      ubiAmount.addEventListener("change", updateCalculators);
      exemptionAmount.addEventListener("change", updateCalculators);

      // Language selector functionality
      languageSelector.addEventListener("change", (event) => {
        const language = event.target.value;
        console.log(`Language changed to: ${language}`);

        // Apply translations to the page
        applyTranslations(language);

        // Re-initialize the percentage display after translation
        initializePercentageDisplay();

        // Update calculators with new language
        updateCalculators();
      });

      // Function to update calculators with current parameters
      function updateCalculators() {
        const params = {
          year: taxYear.value,
          ubiAmount: ubiAmount.value,
          taxPercentage: taxPercentage.value,
          exemptionAmount: exemptionAmount.value,
          language: languageSelector.value,
        };

        // Update quintile iframe
        if (quintileIframe) {
          const quintileUrl = new URL(
            quintileIframe.src,
            window.location.origin
          );
          Object.entries(params).forEach(([key, value]) => {
            quintileUrl.searchParams.set(key, value);
          });
          quintileIframe.src = quintileUrl.toString();
        }

        // Update decile iframe
        if (decileIframe) {
          const decileUrl = new URL(decileIframe.src, window.location.origin);
          Object.entries(params).forEach(([key, value]) => {
            decileUrl.searchParams.set(key, value);
          });
          decileIframe.src = decileUrl.toString();
        }
      }

      // Initialize the page
      document.addEventListener("DOMContentLoaded", async () => {
        // Get language from URL or default to English
        const urlParams = new URLSearchParams(window.location.search);
        const language = urlParams.get("language") || "en";

        // Set language selector to match URL parameter
        languageSelector.value = language;

        // Apply translations
        applyTranslations(language);

        // Initialize the percentage display AFTER translations
        initializePercentageDisplay();

        // Populate year dropdown with database years
        await populateYearDropdown();

        // Initialize calculators
        updateCalculators();
      });
    </script>
  </body>
</html>
