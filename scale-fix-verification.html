<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scale Fix Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        iframe { width: 100%; height: 600px; border: 2px solid #007bff; margin: 10px 0; border-radius: 5px; }
        .expected-values { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .comparison-item { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üéØ Scale Fix Verification</h1>
    
    <div class="expected-values">
        <h3>‚úÖ Expected Correct Values</h3>
        <p><strong>Y-axis should now show reasonable values like:</strong></p>
        <ul>
            <li>$0k, $50k, $100k, $150k, $200k, $250k (not huge numbers)</li>
            <li>Decile 1: ~$8.5k income</li>
            <li>Decile 5: ~$50k income</li>
            <li>Decile 10: ~$250k income</li>
            <li>UBI bars should be ~$24k high</li>
            <li>Break-even line should be around $56k</li>
        </ul>
    </div>
    
    <div id="overall-result" class="status info">üîç Testing scale fix...</div>
    
    <div class="comparison">
        <div class="comparison-item">
            <h3>üìä Fixed Chart (Direct)</h3>
            <iframe id="direct-chart" src="/decile-calculator-svg-demo.html?ubiAmount=24&taxPercentage=30&exemptionAmount=24"></iframe>
            <div id="direct-result" class="status info">Loading...</div>
        </div>
        
        <div class="comparison-item">
            <h3>üñ•Ô∏è Standalone App</h3>
            <iframe id="standalone-app" src="/standalone-app.html"></iframe>
            <div id="standalone-result" class="status info">Loading...</div>
        </div>
    </div>
    
    <div id="detailed-analysis"></div>
    
    <script>
        const overallResult = document.getElementById('overall-result');
        const directResult = document.getElementById('direct-result');
        const standaloneResult = document.getElementById('standalone-result');
        const detailedAnalysis = document.getElementById('detailed-analysis');
        const directChart = document.getElementById('direct-chart');
        const standaloneApp = document.getElementById('standalone-app');
        
        let directSuccess = false;
        let standaloneSuccess = false;
        let testDetails = [];
        
        function addDetail(message) {
            testDetails.push(`${new Date().toLocaleTimeString()}: ${message}`);
            updateDetailedAnalysis();
        }
        
        function updateDetailedAnalysis() {
            detailedAnalysis.innerHTML = `
                <div class="expected-values">
                    <h3>üîç Scale Analysis Results</h3>
                    ${testDetails.map(detail => `<div style="margin: 5px 0; font-family: monospace; font-size: 14px;">${detail}</div>`).join('')}
                </div>
            `;
        }
        
        function updateOverallResult() {
            if (directSuccess && standaloneSuccess) {
                overallResult.className = 'status success';
                overallResult.innerHTML = 'üéâ <strong>SCALE FIXED!</strong> Chart is now displaying correct values. Phase 2 refactoring complete!';
            } else if (directSuccess || standaloneSuccess) {
                overallResult.className = 'status info';
                overallResult.innerHTML = '‚ö†Ô∏è <strong>PARTIAL SUCCESS</strong> - Some charts working correctly.';
            } else {
                overallResult.className = 'status error';
                overallResult.innerHTML = '‚ùå <strong>SCALE STILL BROKEN</strong> - Chart values are not displaying correctly.';
            }
        }
        
        // Test direct chart
        directChart.addEventListener('load', () => {
            addDetail('Direct chart loaded');
            
            setTimeout(() => {
                try {
                    const iframeDoc = directChart.contentDocument;
                    const incomeChart = iframeDoc.getElementById('incomeChart');
                    
                    if (incomeChart) {
                        // Check Y-axis labels for reasonable values
                        const yLabels = incomeChart.querySelectorAll('text');
                        const yAxisLabels = Array.from(yLabels).filter(label => 
                            label.textContent.includes('$') && label.textContent.includes('k')
                        );
                        
                        addDetail(`Found ${yAxisLabels.length} Y-axis labels`);
                        
                        let reasonableScale = true;
                        yAxisLabels.forEach(label => {
                            const text = label.textContent;
                            addDetail(`Y-axis label: ${text}`);
                            
                            // Extract number from label like "$250k"
                            const match = text.match(/\$(\d+)k/);
                            if (match) {
                                const value = parseInt(match[1]);
                                // Check if values are reasonable (0-300k range)
                                if (value > 500) {
                                    reasonableScale = false;
                                    addDetail(`‚ùå Unreasonable Y-axis value: ${value}k`);
                                }
                            }
                        });
                        
                        // Check bar structure
                        const allRects = incomeChart.querySelectorAll('rect');
                        const incomeBars = incomeChart.querySelectorAll('.before-tax-income-bar');
                        const ubiBars = incomeChart.querySelectorAll('.ubi-amount-bar');
                        
                        addDetail(`Chart structure: ${allRects.length} total bars, ${incomeBars.length} income, ${ubiBars.length} UBI`);
                        
                        if (reasonableScale && allRects.length >= 40 && incomeBars.length === 10 && ubiBars.length === 10) {
                            directSuccess = true;
                            directResult.className = 'status success';
                            directResult.innerHTML = '‚úÖ <strong>PERFECT!</strong> Scale fixed and chart working correctly';
                            addDetail('‚úÖ Direct chart: Scale and structure both correct');
                        } else if (reasonableScale) {
                            directResult.className = 'status info';
                            directResult.innerHTML = '‚úÖ <strong>SCALE FIXED</strong> but chart structure may need work';
                            addDetail('‚úÖ Direct chart: Scale fixed, structure partial');
                        } else {
                            directResult.className = 'status error';
                            directResult.innerHTML = '‚ùå <strong>SCALE STILL BROKEN</strong>';
                            addDetail('‚ùå Direct chart: Scale still showing unreasonable values');
                        }
                        
                    } else {
                        directResult.className = 'status error';
                        directResult.innerHTML = '‚ùå <strong>ERROR</strong> Chart element not found';
                        addDetail('‚ùå Direct chart: SVG element not found');
                    }
                } catch (e) {
                    directResult.className = 'status error';
                    directResult.innerHTML = `‚ùå <strong>ERROR</strong> ${e.message}`;
                    addDetail(`‚ùå Direct chart error: ${e.message}`);
                }
                updateOverallResult();
            }, 4000);
        });
        
        // Test standalone app
        standaloneApp.addEventListener('load', () => {
            addDetail('Standalone app loaded');
            
            setTimeout(() => {
                try {
                    const iframeDoc = standaloneApp.contentDocument;
                    const decileIframe = iframeDoc.getElementById('decileIframe');
                    
                    if (decileIframe) {
                        setTimeout(() => {
                            try {
                                const nestedDoc = decileIframe.contentDocument;
                                const incomeChart = nestedDoc.getElementById('incomeChart');
                                
                                if (incomeChart) {
                                    const allRects = incomeChart.querySelectorAll('rect');
                                    addDetail(`Standalone chart: ${allRects.length} bars found`);
                                    
                                    if (allRects.length >= 40) {
                                        standaloneSuccess = true;
                                        standaloneResult.className = 'status success';
                                        standaloneResult.innerHTML = '‚úÖ <strong>SUCCESS!</strong> Standalone app working with fixed scale';
                                        addDetail('‚úÖ Standalone app: Chart working correctly');
                                    } else {
                                        standaloneResult.className = 'status info';
                                        standaloneResult.innerHTML = '‚ö†Ô∏è <strong>PARTIAL</strong> Some rendering issues';
                                        addDetail('‚ö†Ô∏è Standalone app: Partial rendering');
                                    }
                                } else {
                                    standaloneResult.className = 'status error';
                                    standaloneResult.innerHTML = '‚ùå <strong>ERROR</strong> Nested chart not found';
                                    addDetail('‚ùå Standalone app: Nested chart not found');
                                }
                            } catch (e) {
                                standaloneResult.className = 'status error';
                                standaloneResult.innerHTML = `‚ùå <strong>ERROR</strong> Nested access failed`;
                                addDetail(`‚ùå Standalone app nested error: ${e.message}`);
                            }
                            updateOverallResult();
                        }, 3000);
                    } else {
                        standaloneResult.className = 'status error';
                        standaloneResult.innerHTML = '‚ùå <strong>ERROR</strong> Decile iframe not found';
                        addDetail('‚ùå Standalone app: Decile iframe not found');
                        updateOverallResult();
                    }
                } catch (e) {
                    standaloneResult.className = 'status error';
                    standaloneResult.innerHTML = `‚ùå <strong>ERROR</strong> ${e.message}`;
                    addDetail(`‚ùå Standalone app error: ${e.message}`);
                    updateOverallResult();
                }
            }, 3000);
        });
    </script>
</body>
</html>
