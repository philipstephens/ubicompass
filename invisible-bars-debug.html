<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invisible Bars Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #dee2e6; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; margin: 10px 0; }
        .code { background: #e9ecef; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Invisible Bars Debug Tool</h1>
    
    <div class="debug warning">
        <h3>üîç Investigating Why Bars Are Invisible</h3>
        <p>The bars might be:</p>
        <ul>
            <li>Created with zero or negative height</li>
            <li>Positioned outside the visible area</li>
            <li>Missing gradients or fill colors</li>
            <li>Hidden behind other elements</li>
            <li>Created but not appended to the DOM</li>
        </ul>
    </div>
    
    <div id="debug-output"></div>
    
    <iframe id="chart-iframe" src="/decile-calculator-svg-demo.html?ubiAmount=24&taxPercentage=30&exemptionAmount=24"></iframe>
    
    <script>
        const debugOutput = document.getElementById('debug-output');
        const iframe = document.getElementById('chart-iframe');
        
        function addDebug(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            debugOutput.appendChild(div);
        }
        
        iframe.addEventListener('load', () => {
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument;
                    const iframeWindow = iframe.contentWindow;
                    
                    addDebug('Investigating invisible bars...', 'info');
                    
                    const incomeChart = iframeDoc.getElementById('incomeChart');
                    if (!incomeChart) {
                        addDebug('‚ùå Income chart not found', 'error');
                        return;
                    }
                    
                    // Get all rectangles and analyze them
                    const allRects = incomeChart.querySelectorAll('rect');
                    addDebug(`Total rectangles found: ${allRects.length}`, 'info');
                    
                    // Create detailed analysis table
                    let tableHTML = `
                        <table>
                            <tr>
                                <th>Index</th>
                                <th>Class</th>
                                <th>X</th>
                                <th>Y</th>
                                <th>Width</th>
                                <th>Height</th>
                                <th>Fill</th>
                                <th>Visible?</th>
                            </tr>
                    `;
                    
                    allRects.forEach((rect, index) => {
                        const x = rect.getAttribute('x');
                        const y = rect.getAttribute('y');
                        const width = rect.getAttribute('width');
                        const height = rect.getAttribute('height');
                        const fill = rect.getAttribute('fill');
                        const className = rect.getAttribute('class') || 'no-class';
                        
                        const heightNum = parseFloat(height);
                        const yNum = parseFloat(y);
                        const xNum = parseFloat(x);
                        
                        // Check if bar is visible
                        let visible = 'Unknown';
                        if (heightNum <= 0) {
                            visible = '‚ùå Zero height';
                        } else if (yNum < 0) {
                            visible = '‚ùå Above viewport';
                        } else if (yNum > 500) {
                            visible = '‚ùå Below viewport';
                        } else if (xNum < 0) {
                            visible = '‚ùå Left of viewport';
                        } else if (xNum > 1000) {
                            visible = '‚ùå Right of viewport';
                        } else if (!fill || fill === 'none') {
                            visible = '‚ùå No fill';
                        } else {
                            visible = '‚úÖ Should be visible';
                        }
                        
                        const rowClass = visible.includes('‚ùå') ? 'error' : 'success';
                        
                        tableHTML += `
                            <tr style="background-color: ${visible.includes('‚ùå') ? '#ffebee' : '#e8f5e8'}">
                                <td>${index}</td>
                                <td>${className}</td>
                                <td>${x}</td>
                                <td>${y}</td>
                                <td>${width}</td>
                                <td>${height}</td>
                                <td>${fill}</td>
                                <td>${visible}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</table>';
                    
                    addDebug('Detailed bar analysis:', 'info');
                    const tableDiv = document.createElement('div');
                    tableDiv.innerHTML = tableHTML;
                    debugOutput.appendChild(tableDiv);
                    
                    // Check gradients
                    const gradients = incomeChart.querySelectorAll('defs linearGradient');
                    addDebug(`Gradients found: ${gradients.length}`, 'info');
                    
                    gradients.forEach((gradient, index) => {
                        const id = gradient.getAttribute('id');
                        addDebug(`  - Gradient ${index}: id="${id}"`, 'info');
                    });
                    
                    // Test calculations manually
                    if (iframeWindow.decileData && iframeWindow.decileData.length > 0) {
                        addDebug('Testing calculations for first 3 deciles:', 'info');
                        
                        for (let i = 0; i < Math.min(3, iframeWindow.decileData.length); i++) {
                            const entry = iframeWindow.decileData[i];
                            const beforeTaxIncome = entry.averageTaxableIncome / 1000;
                            
                            try {
                                const afterTaxOld = iframeWindow.calculateIncomeWithUBI(beforeTaxIncome);
                                const afterTaxNew = iframeWindow.calculateAfterTaxIncomeNew(beforeTaxIncome);
                                const ubiAmount = iframeWindow.parameterManager.getUbiAmountInThousands();
                                const stackedTotal = beforeTaxIncome + ubiAmount;
                                
                                addDebug(`Decile ${entry.decile} ($${beforeTaxIncome}k income):`, 'info');
                                addDebug(`  - Stacked total: $${Math.round(stackedTotal)}k`, 'info');
                                addDebug(`  - After-tax OLD: $${Math.round(afterTaxOld)}k`, 'info');
                                addDebug(`  - After-tax NEW: $${Math.round(afterTaxNew)}k`, 'info');
                                
                                // Calculate what the bar heights should be
                                const chartHeight = 400; // Approximate chart height
                                const yMax = 300; // Approximate max value
                                const yScale = chartHeight / yMax;
                                
                                const expectedOldHeight = afterTaxOld * yScale;
                                const expectedNewHeight = afterTaxNew * yScale;
                                
                                addDebug(`  - Expected OLD bar height: ${Math.round(expectedOldHeight)}px`, 'info');
                                addDebug(`  - Expected NEW bar height: ${Math.round(expectedNewHeight)}px`, 'info');
                                
                            } catch (e) {
                                addDebug(`  - Calculation error: ${e.message}`, 'error');
                            }
                        }
                    }
                    
                    // Check for specific bar classes
                    const afterTaxOldBars = incomeChart.querySelectorAll('.after-tax-old-bar');
                    const afterTaxNewBars = incomeChart.querySelectorAll('.after-tax-new-bar');
                    
                    addDebug(`After-tax OLD bars found: ${afterTaxOldBars.length}`, afterTaxOldBars.length > 0 ? 'success' : 'error');
                    addDebug(`After-tax NEW bars found: ${afterTaxNewBars.length}`, afterTaxNewBars.length > 0 ? 'success' : 'error');
                    
                    // Check if bars exist but are hidden
                    if (afterTaxOldBars.length === 0 && afterTaxNewBars.length === 0) {
                        addDebug('‚ùå After-tax bars are not being created at all', 'error');
                        
                        // Check if the BarComponent methods are being called
                        addDebug('Checking if BarComponent.createMultiBarGroup is working...', 'warning');
                        
                        // Try to manually call the chart update
                        if (typeof iframeWindow.updateIncomeChart === 'function') {
                            addDebug('Attempting manual chart update...', 'warning');
                            try {
                                iframeWindow.updateIncomeChart();
                                
                                setTimeout(() => {
                                    const newAfterTaxOldBars = incomeChart.querySelectorAll('.after-tax-old-bar');
                                    const newAfterTaxNewBars = incomeChart.querySelectorAll('.after-tax-new-bar');
                                    addDebug(`After manual update - OLD bars: ${newAfterTaxOldBars.length}, NEW bars: ${newAfterTaxNewBars.length}`, 'info');
                                }, 1000);
                                
                            } catch (e) {
                                addDebug(`Manual update error: ${e.message}`, 'error');
                            }
                        }
                    }
                    
                } catch (e) {
                    addDebug(`‚ùå Debug error: ${e.message}`, 'error');
                    addDebug(`Stack: ${e.stack}`, 'error');
                }
            }, 3000);
        });
    </script>
</body>
</html>
