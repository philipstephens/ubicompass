<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Chart Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { margin: 20px 0; }
        .result { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        iframe { width: 100%; height: 700px; border: 1px solid #ccc; margin: 10px 0; }
        .legend { display: flex; gap: 20px; margin: 10px 0; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .color-box { width: 20px; height: 20px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Final Multi-Bar Chart Test</h1>
    
    <div class="test-container">
        <h2>Expected Chart Structure</h2>
        <p>The chart should show 3 bars for each decile:</p>
        <div class="legend">
            <div class="legend-item">
                <div class="color-box" style="background: linear-gradient(to top, #2196f3, #60a5fa);"></div>
                <span>Bar 1 (Bottom): Before-Tax Income</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: linear-gradient(to top, #4caf50, #81c784);"></div>
                <span>Bar 1 (Top): UBI Amount (stacked)</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: linear-gradient(to top, #673ab7, #9c27b0);"></div>
                <span>Bar 2: After-Tax Income (Old)</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background: linear-gradient(to top, #ff9800, #ffb74d);"></div>
                <span>Bar 3: After-Tax Income (New)</span>
            </div>
        </div>
    </div>
    
    <div class="test-container">
        <h2>Chart Test Results</h2>
        <div id="test-results"></div>
    </div>
    
    <div class="test-container">
        <h2>Live Chart</h2>
        <iframe id="chart-iframe" src="/decile-calculator-svg-demo.html?ubiAmount=24&taxPercentage=30&exemptionAmount=24&year=2022"></iframe>
    </div>
    
    <script>
        const resultsDiv = document.getElementById('test-results');
        const iframe = document.getElementById('chart-iframe');
        
        function addResult(message, type = 'success') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            resultsDiv.appendChild(div);
        }
        
        iframe.addEventListener('load', () => {
            addResult('✅ Chart iframe loaded successfully');
            
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // Check for income chart
                    const incomeChart = iframeDoc.getElementById('incomeChart');
                    if (incomeChart) {
                        addResult('✅ Income chart SVG found');
                        
                        // Count different types of bars
                        const allRects = incomeChart.querySelectorAll('rect');
                        const incomeBars = incomeChart.querySelectorAll('.income-bar');
                        const ubiBars = incomeChart.querySelectorAll('.ubi-bar');
                        const afterTaxOldBars = incomeChart.querySelectorAll('.after-tax-old-bar');
                        const afterTaxNewBars = incomeChart.querySelectorAll('.after-tax-new-bar');
                        
                        addResult(`✅ Total rectangles: ${allRects.length}`);
                        addResult(`✅ Income bars (blue): ${incomeBars.length}`);
                        addResult(`✅ UBI bars (green): ${ubiBars.length}`);
                        addResult(`✅ After-tax old bars (purple): ${afterTaxOldBars.length}`);
                        addResult(`✅ After-tax new bars (orange): ${afterTaxNewBars.length}`);
                        
                        // Check if we have the expected structure (10 deciles × 3 bars each = 30 bars minimum)
                        const expectedMinBars = 30;
                        if (allRects.length >= expectedMinBars) {
                            addResult(`✅ Sufficient bars found (${allRects.length} >= ${expectedMinBars})`);
                        } else {
                            addResult(`⚠️ Fewer bars than expected (${allRects.length} < ${expectedMinBars})`, 'warning');
                        }
                        
                        // Check if each type has 10 bars (one per decile)
                        if (incomeBars.length === 10) {
                            addResult('✅ Correct number of income bars (10)');
                        } else {
                            addResult(`⚠️ Unexpected number of income bars (${incomeBars.length} instead of 10)`, 'warning');
                        }
                        
                        if (ubiBars.length === 10) {
                            addResult('✅ Correct number of UBI bars (10)');
                        } else {
                            addResult(`⚠️ Unexpected number of UBI bars (${ubiBars.length} instead of 10)`, 'warning');
                        }
                        
                        if (afterTaxOldBars.length === 10) {
                            addResult('✅ Correct number of after-tax old bars (10)');
                        } else {
                            addResult(`⚠️ Unexpected number of after-tax old bars (${afterTaxOldBars.length} instead of 10)`, 'warning');
                        }
                        
                        if (afterTaxNewBars.length === 10) {
                            addResult('✅ Correct number of after-tax new bars (10)');
                        } else {
                            addResult(`⚠️ Unexpected number of after-tax new bars (${afterTaxNewBars.length} instead of 10)`, 'warning');
                        }
                        
                        // Check legend
                        const legendItems = iframeDoc.querySelectorAll('.legend-item span');
                        const legendTexts = Array.from(legendItems).map(span => span.textContent);
                        
                        if (legendTexts.some(text => text.includes('Before-Tax Income'))) {
                            addResult('✅ "Before-Tax Income" legend found');
                        } else {
                            addResult('❌ "Before-Tax Income" legend missing', 'error');
                        }
                        
                        if (legendTexts.some(text => text.includes('UBI Amount'))) {
                            addResult('✅ "UBI Amount" legend found');
                        } else {
                            addResult('❌ "UBI Amount" legend missing', 'error');
                        }
                        
                        if (legendTexts.some(text => text.includes('After-Tax Income (Old)'))) {
                            addResult('✅ "After-Tax Income (Old)" legend found');
                        } else {
                            addResult('❌ "After-Tax Income (Old)" legend missing', 'error');
                        }
                        
                        if (legendTexts.some(text => text.includes('After-Tax Income (New)'))) {
                            addResult('✅ "After-Tax Income (New)" legend found');
                        } else {
                            addResult('❌ "After-Tax Income (New)" legend missing', 'error');
                        }
                        
                    } else {
                        addResult('❌ Income chart SVG not found', 'error');
                    }
                    
                } catch (e) {
                    addResult(`❌ Error accessing iframe: ${e.message}`, 'error');
                }
            }, 3000); // Wait 3 seconds for chart to render
        });
        
        iframe.addEventListener('error', () => {
            addResult('❌ Chart iframe failed to load', 'error');
        });
    </script>
</body>
</html>
