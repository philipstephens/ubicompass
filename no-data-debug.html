<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No Data Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #dee2e6; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; margin: 10px 0; }
        .code { background: #e9ecef; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>No Data Debug Tool</h1>
    
    <div id="debug-output"></div>
    
    <iframe id="chart-iframe" src="/decile-calculator-svg-demo.html?ubiAmount=24&taxPercentage=30&exemptionAmount=24"></iframe>
    
    <script>
        const debugOutput = document.getElementById('debug-output');
        const iframe = document.getElementById('chart-iframe');
        
        function addDebug(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            debugOutput.appendChild(div);
        }
        
        iframe.addEventListener('load', () => {
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument;
                    const iframeWindow = iframe.contentWindow;
                    
                    addDebug('Starting comprehensive debug...', 'info');
                    
                    // Check 1: Basic elements
                    const incomeChart = iframeDoc.getElementById('incomeChart');
                    if (incomeChart) {
                        addDebug('‚úÖ Income chart SVG element found', 'success');
                        addDebug(`SVG innerHTML length: ${incomeChart.innerHTML.length}`, 'info');
                        
                        if (incomeChart.innerHTML.length < 100) {
                            addDebug('‚ö†Ô∏è SVG appears to be empty or nearly empty', 'warning');
                        }
                    } else {
                        addDebug('‚ùå Income chart SVG element NOT found', 'error');
                        return;
                    }
                    
                    // Check 2: Data availability
                    if (iframeWindow.decileData) {
                        addDebug(`‚úÖ decileData found with ${iframeWindow.decileData.length} entries`, 'success');
                        
                        if (iframeWindow.decileData.length === 0) {
                            addDebug('‚ùå decileData is empty array', 'error');
                        } else {
                            // Show first entry
                            const firstEntry = iframeWindow.decileData[0];
                            addDebug(`First entry: ${JSON.stringify(firstEntry)}`, 'info');
                        }
                    } else {
                        addDebug('‚ùå decileData not found or undefined', 'error');
                    }
                    
                    // Check 3: Chart builder instances
                    if (iframeWindow.incomeChartBuilder) {
                        addDebug('‚úÖ incomeChartBuilder instance found', 'success');
                    } else {
                        addDebug('‚ùå incomeChartBuilder instance NOT found', 'error');
                    }
                    
                    if (iframeWindow.incomeBarComponent) {
                        addDebug('‚úÖ incomeBarComponent instance found', 'success');
                    } else {
                        addDebug('‚ùå incomeBarComponent instance NOT found', 'error');
                    }
                    
                    // Check 4: Parameter manager
                    if (iframeWindow.parameterManager) {
                        addDebug('‚úÖ parameterManager found', 'success');
                        const params = iframeWindow.parameterManager.getUrlParams();
                        addDebug(`Parameters: ${JSON.stringify(params)}`, 'info');
                    } else {
                        addDebug('‚ùå parameterManager NOT found', 'error');
                    }
                    
                    // Check 5: Try to manually call updateIncomeChart
                    if (typeof iframeWindow.updateIncomeChart === 'function') {
                        addDebug('‚úÖ updateIncomeChart function found', 'success');
                        
                        try {
                            addDebug('üîß Attempting to manually call updateIncomeChart...', 'warning');
                            iframeWindow.updateIncomeChart();
                            
                            setTimeout(() => {
                                const rects = incomeChart.querySelectorAll('rect');
                                addDebug(`After manual call: ${rects.length} rectangles found`, rects.length > 0 ? 'success' : 'error');
                            }, 1000);
                            
                        } catch (e) {
                            addDebug(`‚ùå Error calling updateIncomeChart: ${e.message}`, 'error');
                            addDebug(`Stack trace: ${e.stack}`, 'error');
                        }
                    } else {
                        addDebug('‚ùå updateIncomeChart function NOT found', 'error');
                    }
                    
                    // Check 6: Console errors
                    const originalConsoleError = iframeWindow.console.error;
                    iframeWindow.console.error = function(...args) {
                        addDebug(`Console Error: ${args.join(' ')}`, 'error');
                        originalConsoleError.apply(this, args);
                    };
                    
                    // Check 7: Current chart content
                    const allElements = incomeChart.querySelectorAll('*');
                    addDebug(`Total SVG child elements: ${allElements.length}`, 'info');
                    
                    if (allElements.length > 0) {
                        const elementTypes = {};
                        allElements.forEach(el => {
                            const tagName = el.tagName.toLowerCase();
                            elementTypes[tagName] = (elementTypes[tagName] || 0) + 1;
                        });
                        addDebug(`Element breakdown: ${JSON.stringify(elementTypes)}`, 'info');
                    }
                    
                    // Check 8: Look for any error indicators
                    const errorElements = iframeDoc.querySelectorAll('.error, [class*="error"]');
                    if (errorElements.length > 0) {
                        addDebug(`Found ${errorElements.length} elements with error classes`, 'warning');
                    }
                    
                } catch (e) {
                    addDebug(`‚ùå Debug error: ${e.message}`, 'error');
                    addDebug(`Stack: ${e.stack}`, 'error');
                }
            }, 3000);
        });
        
        iframe.addEventListener('error', () => {
            addDebug('‚ùå Iframe failed to load', 'error');
        });
    </script>
</body>
</html>
