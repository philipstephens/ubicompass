<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Diagnostic Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .diagnostic { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        .info { border-left: 4px solid #17a2b8; }
        iframe { width: 100%; height: 600px; border: 2px solid #007bff; margin: 10px 0; }
        .code { background: #e9ecef; padding: 10px; border-radius: 3px; font-family: monospace; margin: 5px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>Chart Diagnostic Tool</h1>
    
    <button onclick="runDiagnostic()">Run Full Diagnostic</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="diagnostic-results"></div>
    
    <h3>Live Chart</h3>
    <iframe id="chart-iframe" src="/decile-calculator-svg-demo.html?ubiAmount=24&taxPercentage=30&exemptionAmount=24"></iframe>
    
    <script>
        const resultsDiv = document.getElementById('diagnostic-results');
        const iframe = document.getElementById('chart-iframe');
        let diagnosticResults = [];
        
        function addDiagnostic(title, message, type = 'info', code = null) {
            const diagnostic = {
                title,
                message,
                type,
                code,
                timestamp: new Date().toLocaleTimeString()
            };
            diagnosticResults.push(diagnostic);
            updateDisplay();
        }
        
        function updateDisplay() {
            resultsDiv.innerHTML = diagnosticResults.map(d => `
                <div class="diagnostic ${d.type}">
                    <h4>[${d.timestamp}] ${d.title}</h4>
                    <p>${d.message}</p>
                    ${d.code ? `<div class="code">${d.code}</div>` : ''}
                </div>
            `).join('');
        }
        
        function clearResults() {
            diagnosticResults = [];
            updateDisplay();
        }
        
        async function runDiagnostic() {
            clearResults();
            addDiagnostic('Starting Diagnostic', 'Beginning comprehensive chart analysis...', 'info');
            
            try {
                // Wait for iframe to load
                await new Promise(resolve => {
                    if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                        resolve();
                    } else {
                        iframe.addEventListener('load', resolve, { once: true });
                    }
                });
                
                const iframeDoc = iframe.contentDocument;
                const iframeWindow = iframe.contentWindow;
                
                // Check 1: Basic page structure
                addDiagnostic('Page Structure', 'Checking basic HTML elements...', 'info');
                
                const incomeChart = iframeDoc.getElementById('incomeChart');
                const costChart = iframeDoc.getElementById('costChart');
                const incomeView = iframeDoc.getElementById('incomeView');
                
                if (incomeChart) {
                    addDiagnostic('‚úÖ Chart Elements', 'Income chart SVG element found', 'success');
                } else {
                    addDiagnostic('‚ùå Chart Elements', 'Income chart SVG element NOT found', 'error');
                    return;
                }
                
                // Check 2: JavaScript classes
                addDiagnostic('JavaScript Classes', 'Checking refactored classes...', 'info');
                
                if (iframeWindow.parameterManager) {
                    const params = iframeWindow.parameterManager.getUrlParams();
                    addDiagnostic('‚úÖ ParameterManager', `Found and working. UBI: $${params.ubiAmount}k, Tax: ${params.taxPercentage}%`, 'success', 
                        `parameterManager.getUrlParams() = ${JSON.stringify(params, null, 2)}`);
                } else {
                    addDiagnostic('‚ùå ParameterManager', 'ParameterManager instance not found', 'error');
                }
                
                if (iframeWindow.taxCalculator) {
                    addDiagnostic('‚úÖ TaxCalculator', 'TaxCalculator instance found', 'success');
                    
                    // Test a calculation
                    try {
                        const testIncome = 50; // $50k
                        const afterTaxNew = iframeWindow.taxCalculator.calculateAfterTaxIncomeNew(testIncome);
                        addDiagnostic('‚úÖ Calculation Test', `Test calculation works: $50k ‚Üí $${Math.round(afterTaxNew)}k after tax`, 'success',
                            `taxCalculator.calculateAfterTaxIncomeNew(50) = ${afterTaxNew}`);
                    } catch (e) {
                        addDiagnostic('‚ùå Calculation Test', `Calculation failed: ${e.message}`, 'error');
                    }
                } else {
                    addDiagnostic('‚ùå TaxCalculator', 'TaxCalculator instance not found', 'error');
                }
                
                // Check 3: Data
                addDiagnostic('Data Loading', 'Checking decile data...', 'info');
                
                if (iframeWindow.decileData && iframeWindow.decileData.length > 0) {
                    addDiagnostic('‚úÖ Decile Data', `Found ${iframeWindow.decileData.length} deciles`, 'success',
                        `First decile: ${JSON.stringify(iframeWindow.decileData[0], null, 2)}`);
                } else {
                    addDiagnostic('‚ùå Decile Data', 'No decile data found or empty', 'error');
                }
                
                // Check 4: Chart rendering
                addDiagnostic('Chart Rendering', 'Analyzing SVG content...', 'info');
                
                const allRects = incomeChart.querySelectorAll('rect');
                const incomeBars = incomeChart.querySelectorAll('.income-bar');
                const ubiBars = incomeChart.querySelectorAll('.ubi-bar');
                const afterTaxOldBars = incomeChart.querySelectorAll('.after-tax-old-bar');
                const afterTaxNewBars = incomeChart.querySelectorAll('.after-tax-new-bar');
                
                addDiagnostic('Chart Content', `Total rectangles: ${allRects.length}`, 'info',
                    `Income bars: ${incomeBars.length}\nUBI bars: ${ubiBars.length}\nAfter-tax old: ${afterTaxOldBars.length}\nAfter-tax new: ${afterTaxNewBars.length}`);
                
                if (allRects.length === 0) {
                    addDiagnostic('‚ùå No Bars', 'No rectangles found in chart - chart not rendering', 'error');
                    
                    // Check if updateIncomeChart function exists and try to call it
                    if (typeof iframeWindow.updateIncomeChart === 'function') {
                        addDiagnostic('üîß Attempting Fix', 'Trying to manually trigger chart update...', 'warning');
                        try {
                            iframeWindow.updateIncomeChart();
                            
                            // Check again after manual update
                            setTimeout(() => {
                                const newRects = incomeChart.querySelectorAll('rect');
                                if (newRects.length > 0) {
                                    addDiagnostic('‚úÖ Manual Fix', `Chart updated! Now showing ${newRects.length} bars`, 'success');
                                } else {
                                    addDiagnostic('‚ùå Manual Fix Failed', 'Chart still not rendering after manual update', 'error');
                                }
                            }, 1000);
                        } catch (e) {
                            addDiagnostic('‚ùå Manual Fix Error', `Error calling updateIncomeChart: ${e.message}`, 'error');
                        }
                    }
                } else if (allRects.length < 30) {
                    addDiagnostic('‚ö†Ô∏è Partial Rendering', `Expected ~40 bars (10 deciles √ó 4 bars), found ${allRects.length}`, 'warning');
                } else {
                    addDiagnostic('‚úÖ Chart Rendered', `Chart appears to be rendering correctly with ${allRects.length} bars`, 'success');
                }
                
                // Check 5: Console errors
                addDiagnostic('Console Check', 'Monitoring for JavaScript errors...', 'info');
                
                // Set up error monitoring
                iframeWindow.addEventListener('error', (event) => {
                    addDiagnostic('‚ùå JavaScript Error', `${event.message} at line ${event.lineno}`, 'error');
                });
                
            } catch (e) {
                addDiagnostic('‚ùå Diagnostic Error', `Failed to run diagnostic: ${e.message}`, 'error');
            }
        }
        
        // Auto-run diagnostic when iframe loads
        iframe.addEventListener('load', () => {
            setTimeout(runDiagnostic, 2000);
        });
    </script>
</body>
</html>
