<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculation Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test {
        background: #f8f9fa;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      .negative {
        background-color: #ffebee;
        color: #c62828;
      }
      .positive {
        background-color: #e8f5e8;
        color: #2e7d32;
      }
    </style>
  </head>
  <body>
    <h1>Calculation Test</h1>

    <div class="test">
      <h3>Testing After-Tax Calculations</h3>
      <p>
        Let's manually test the calculations to see if they're producing
        reasonable values.
      </p>
    </div>

    <div id="results"></div>

    <script>
      // Mock the classes and data for testing
      class ParameterManager {
        constructor() {
          this.params = {
            ubiAmount: 24000, // $24k in dollars
            taxPercentage: 30,
            exemptionAmount: 24000, // $24k in dollars
          };
        }

        getUbiAmountInDollars() {
          return this.params.ubiAmount;
        }
        getUbiAmountInThousands() {
          return this.params.ubiAmount / 1000;
        }
        getTaxRate() {
          return this.params.taxPercentage / 100;
        }
        getExemptionAmountInDollars() {
          return this.params.exemptionAmount;
        }
      }

      class TaxCalculator {
        constructor(parameterManager) {
          this.params = parameterManager;
        }

        // Old calculation (progressive tax)
        calculateIncomeWithUBI(beforeTaxIncomeInThousands) {
          const beforeTaxIncome = beforeTaxIncomeInThousands * 1000;
          const ubiInDollars = this.params.getUbiAmountInDollars();

          let tax = 0;
          if (beforeTaxIncome > 50000) {
            tax += (beforeTaxIncome - 50000) * 0.25;
          }
          if (beforeTaxIncome > 100000) {
            tax += (beforeTaxIncome - 100000) * 0.1;
          }

          const afterTaxIncome = beforeTaxIncome - tax + ubiInDollars;
          return afterTaxIncome / 1000;
        }

        // New calculation (flat tax)
        calculateAfterTaxIncomeNew(beforeTaxIncomeInThousands) {
          const beforeTaxIncome = beforeTaxIncomeInThousands * 1000;
          const ubi = this.params.getUbiAmountInDollars();
          const exemptAmount = this.params.getExemptionAmountInDollars();
          const taxRate = this.params.getTaxRate();

          const taxableAmount = Math.max(
            0,
            beforeTaxIncome + ubi - exemptAmount
          );
          const taxPaid = taxableAmount * taxRate;
          const afterTaxIncome = beforeTaxIncome + ubi - taxPaid;
          const finalIncome = Math.max(0, afterTaxIncome);

          return finalIncome / 1000;
        }
      }

      // Test data (same as fallback data)
      const testData = [
        { decile: 1, averageTaxableIncome: 8500 },
        { decile: 2, averageTaxableIncome: 20000 },
        { decile: 3, averageTaxableIncome: 30000 },
        { decile: 4, averageTaxableIncome: 40000 },
        { decile: 5, averageTaxableIncome: 50000 },
        { decile: 6, averageTaxableIncome: 62500 },
        { decile: 7, averageTaxableIncome: 77500 },
        { decile: 8, averageTaxableIncome: 95000 },
        { decile: 9, averageTaxableIncome: 125000 },
        { decile: 10, averageTaxableIncome: 250000 },
      ];

      // Initialize
      const paramManager = new ParameterManager();
      const taxCalc = new TaxCalculator(paramManager);

      // Test calculations
      const resultsDiv = document.getElementById("results");

      let tableHTML = `
            <table>
                <tr>
                    <th>Decile</th>
                    <th>Before-Tax Income</th>
                    <th>Stacked Total<br>(Before-Tax + UBI)</th>
                    <th>After-Tax OLD<br>(Progressive)</th>
                    <th>After-Tax NEW<br>(Flat Tax)</th>
                    <th>OLD Height<br>(pixels)</th>
                    <th>NEW Height<br>(pixels)</th>
                </tr>
        `;

      const ubiAmount = paramManager.getUbiAmountInThousands();
      const chartHeight = 400;
      const yMax = 300; // Approximate max value for scaling
      const yScale = chartHeight / yMax;

      testData.forEach((entry) => {
        const beforeTaxIncome = entry.averageTaxableIncome / 1000; // Convert to thousands
        const stackedTotal = beforeTaxIncome + ubiAmount;
        const afterTaxOld = taxCalc.calculateIncomeWithUBI(beforeTaxIncome);
        const afterTaxNew = taxCalc.calculateAfterTaxIncomeNew(beforeTaxIncome);

        const oldHeight = afterTaxOld * yScale;
        const newHeight = afterTaxNew * yScale;

        const oldClass = afterTaxOld < 0 ? "negative" : "positive";
        const newClass = afterTaxNew < 0 ? "negative" : "positive";

        tableHTML += `
                <tr>
                    <td>D${entry.decile}</td>
                    <td>$${beforeTaxIncome}k</td>
                    <td>$${Math.round(stackedTotal)}k</td>
                    <td class="${oldClass}">$${Math.round(afterTaxOld)}k</td>
                    <td class="${newClass}">$${Math.round(afterTaxNew)}k</td>
                    <td class="${oldHeight > 0 ? "positive" : "negative"}">${Math.round(oldHeight)}px</td>
                    <td class="${newHeight > 0 ? "positive" : "negative"}">${Math.round(newHeight)}px</td>
                </tr>
            `;
      });

      tableHTML += "</table>";

      resultsDiv.innerHTML = `
            <div class="test">
                <h3>Calculation Results</h3>
                <p><strong>Parameters:</strong> UBI=$${ubiAmount}k, Tax Rate=30%, Exemption=$24k</p>
                <p><strong>Chart Scale:</strong> Y-max=${yMax}k, Chart Height=${chartHeight}px, Scale=${yScale.toFixed(2)} px/k</p>
                ${tableHTML}
            </div>
            
            <div class="test">
                <h3>Analysis</h3>
                <ul>
                    <li><strong>Red values:</strong> Negative income (problematic)</li>
                    <li><strong>Green values:</strong> Positive income (good)</li>
                    <li><strong>Zero height bars:</strong> Will be invisible in chart</li>
                    <li><strong>Negative height bars:</strong> Will cause rendering issues</li>
                </ul>
            </div>
        `;
    </script>
  </body>
</html>
