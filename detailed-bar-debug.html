<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Bar Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #dee2e6; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 4px; text-align: left; }
        th { background-color: #f2f2f2; }
        .highlight { background-color: #fff3cd; }
    </style>
</head>
<body>
    <h1>Detailed Bar Debug Tool</h1>
    
    <div class="debug warning">
        <h3>üîç What We're Looking For</h3>
        <p>Each decile should have exactly 3 bars:</p>
        <ol>
            <li><strong>Stacked bars (2 segments):</strong> before-tax-income-bar + ubi-amount-bar</li>
            <li><strong>After-tax old bar:</strong> after-tax-old-bar (purple)</li>
            <li><strong>After-tax new bar:</strong> after-tax-new-bar (orange)</li>
        </ol>
        <p>Total expected: 10 deciles √ó 4 bars = 40 bars minimum</p>
    </div>
    
    <div id="debug-output"></div>
    
    <iframe id="chart-iframe" src="/decile-calculator-svg-demo.html?ubiAmount=24&taxPercentage=30&exemptionAmount=24"></iframe>
    
    <script>
        const debugOutput = document.getElementById('debug-output');
        const iframe = document.getElementById('chart-iframe');
        
        function addDebug(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            debugOutput.appendChild(div);
        }
        
        iframe.addEventListener('load', () => {
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument;
                    const iframeWindow = iframe.contentWindow;
                    
                    addDebug('Starting detailed bar analysis...', 'info');
                    
                    const incomeChart = iframeDoc.getElementById('incomeChart');
                    if (!incomeChart) {
                        addDebug('‚ùå Income chart not found', 'error');
                        return;
                    }
                    
                    // Get all rectangles
                    const allRects = incomeChart.querySelectorAll('rect');
                    addDebug(`Total rectangles found: ${allRects.length}`, 'info');
                    
                    // Analyze each rectangle in detail
                    let tableHTML = `
                        <table>
                            <tr>
                                <th>Index</th>
                                <th>Class</th>
                                <th>X</th>
                                <th>Y</th>
                                <th>Width</th>
                                <th>Height</th>
                                <th>Fill</th>
                                <th>Visible Area</th>
                                <th>Issues</th>
                            </tr>
                    `;
                    
                    let visibleBars = 0;
                    let barsByClass = {};
                    
                    allRects.forEach((rect, index) => {
                        const x = parseFloat(rect.getAttribute('x'));
                        const y = parseFloat(rect.getAttribute('y'));
                        const width = parseFloat(rect.getAttribute('width'));
                        const height = parseFloat(rect.getAttribute('height'));
                        const fill = rect.getAttribute('fill');
                        const className = rect.getAttribute('class') || 'no-class';
                        
                        // Count by class
                        barsByClass[className] = (barsByClass[className] || 0) + 1;
                        
                        // Check visibility
                        let issues = [];
                        let visibleArea = 'Unknown';
                        
                        if (height <= 0) {
                            issues.push('Zero/negative height');
                        }
                        if (width <= 0) {
                            issues.push('Zero/negative width');
                        }
                        if (y < -50) {
                            issues.push('Above viewport');
                        }
                        if (y > 600) {
                            issues.push('Below viewport');
                        }
                        if (x < -50) {
                            issues.push('Left of viewport');
                        }
                        if (x > 1200) {
                            issues.push('Right of viewport');
                        }
                        if (!fill || fill === 'none') {
                            issues.push('No fill');
                        }
                        if (fill && fill.includes('url(#') && !fill.includes('Gradient)')) {
                            issues.push('Invalid gradient reference');
                        }
                        
                        if (issues.length === 0) {
                            visibleArea = '‚úÖ Should be visible';
                            visibleBars++;
                        } else {
                            visibleArea = '‚ùå Has issues';
                        }
                        
                        const rowClass = issues.length > 0 ? 'highlight' : '';
                        
                        tableHTML += `
                            <tr class="${rowClass}">
                                <td>${index}</td>
                                <td>${className}</td>
                                <td>${x.toFixed(1)}</td>
                                <td>${y.toFixed(1)}</td>
                                <td>${width.toFixed(1)}</td>
                                <td>${height.toFixed(1)}</td>
                                <td>${fill}</td>
                                <td>${visibleArea}</td>
                                <td>${issues.join(', ') || 'None'}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</table>';
                    
                    // Summary by class
                    let summaryHTML = '<h4>Bar Count by Class:</h4><ul>';
                    Object.entries(barsByClass).forEach(([className, count]) => {
                        const expected = className.includes('before-tax-income') || className.includes('ubi-amount') || 
                                        className.includes('after-tax-old') || className.includes('after-tax-new') ? 10 : '?';
                        const status = (expected === 10 && count === 10) ? '‚úÖ' : 
                                      (expected === 10 && count < 10) ? '‚ùå' : '‚ö†Ô∏è';
                        summaryHTML += `<li>${status} <strong>${className}:</strong> ${count} (expected: ${expected})</li>`;
                    });
                    summaryHTML += '</ul>';
                    
                    addDebug(`Bars that should be visible: ${visibleBars}/${allRects.length}`, visibleBars > 30 ? 'success' : 'error');
                    
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'debug info';
                    summaryDiv.innerHTML = `
                        <h3>üìä Bar Analysis Summary</h3>
                        ${summaryHTML}
                        <h4>Detailed Bar Information:</h4>
                        ${tableHTML}
                    `;
                    debugOutput.appendChild(summaryDiv);
                    
                    // Check gradients
                    const gradients = incomeChart.querySelectorAll('defs linearGradient');
                    addDebug(`Gradients found: ${gradients.length}`, 'info');
                    
                    let gradientHTML = '<h4>Available Gradients:</h4><ul>';
                    gradients.forEach((gradient, index) => {
                        const id = gradient.getAttribute('id');
                        gradientHTML += `<li><strong>${id}</strong></li>`;
                    });
                    gradientHTML += '</ul>';
                    
                    const gradientDiv = document.createElement('div');
                    gradientDiv.className = 'debug info';
                    gradientDiv.innerHTML = gradientHTML;
                    debugOutput.appendChild(gradientDiv);
                    
                    // Test manual bar creation
                    if (iframeWindow.incomeBarComponent && iframeWindow.decileData) {
                        addDebug('Testing manual bar creation...', 'warning');
                        
                        try {
                            const testEntry = iframeWindow.decileData[0];
                            const beforeTaxIncome = testEntry.averageTaxableIncome / 1000;
                            const afterTaxOld = iframeWindow.calculateIncomeWithUBI(beforeTaxIncome);
                            const afterTaxNew = iframeWindow.calculateAfterTaxIncomeNew(beforeTaxIncome);
                            
                            addDebug(`Test calculations for Decile 1:`, 'info');
                            addDebug(`  - Before-tax: $${beforeTaxIncome}k`, 'info');
                            addDebug(`  - After-tax OLD: $${Math.round(afterTaxOld)}k`, 'info');
                            addDebug(`  - After-tax NEW: $${Math.round(afterTaxNew)}k`, 'info');
                            
                            // Check if the bar creation would work
                            const dimensions = iframeWindow.incomeChartBuilder.getDimensions();
                            const yMax = 300; // Approximate
                            const yScale = dimensions.height / yMax;
                            
                            const oldHeight = afterTaxOld * yScale;
                            const newHeight = afterTaxNew * yScale;
                            
                            addDebug(`Expected bar heights:`, 'info');
                            addDebug(`  - OLD bar: ${Math.round(oldHeight)}px`, oldHeight > 0 ? 'success' : 'error');
                            addDebug(`  - NEW bar: ${Math.round(newHeight)}px`, newHeight > 0 ? 'success' : 'error');
                            
                        } catch (e) {
                            addDebug(`Manual test error: ${e.message}`, 'error');
                        }
                    }
                    
                    // Final assessment
                    const expectedClasses = ['before-tax-income-bar', 'ubi-amount-bar', 'after-tax-old-bar', 'after-tax-new-bar'];
                    const missingClasses = expectedClasses.filter(cls => !barsByClass[cls] || barsByClass[cls] < 10);
                    
                    if (missingClasses.length === 0) {
                        addDebug('‚úÖ All expected bar types found with correct counts!', 'success');
                    } else {
                        addDebug(`‚ùå Missing or incomplete bar types: ${missingClasses.join(', ')}`, 'error');
                    }
                    
                } catch (e) {
                    addDebug(`‚ùå Debug error: ${e.message}`, 'error');
                    addDebug(`Stack: ${e.stack}`, 'error');
                }
            }, 3000);
        });
    </script>
</body>
</html>
