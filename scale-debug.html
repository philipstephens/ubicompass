<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scale Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-info { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #dee2e6; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Scale Debug Tool</h1>
    
    <div id="debug-output"></div>
    
    <iframe id="chart-iframe" src="/decile-calculator-svg-demo.html?ubiAmount=24&taxPercentage=30&exemptionAmount=24"></iframe>
    
    <script>
        const debugOutput = document.getElementById('debug-output');
        const iframe = document.getElementById('chart-iframe');
        
        function addDebug(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `debug-info ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            debugOutput.appendChild(div);
        }
        
        iframe.addEventListener('load', () => {
            setTimeout(() => {
                try {
                    const iframeDoc = iframe.contentDocument;
                    const iframeWindow = iframe.contentWindow;
                    
                    addDebug('Checking scaling values...', 'info');
                    
                    // Check if we can access the data
                    if (iframeWindow.decileData && iframeWindow.parameterManager) {
                        const decileData = iframeWindow.decileData;
                        const parameterManager = iframeWindow.parameterManager;
                        const taxCalculator = iframeWindow.taxCalculator;
                        
                        addDebug(`Found ${decileData.length} deciles`, 'success');
                        
                        const ubiAmountInThousands = parameterManager.getUbiAmountInThousands();
                        addDebug(`UBI Amount: $${ubiAmountInThousands}k`, 'info');
                        
                        // Calculate the same values as the chart
                        const maxIncome = Math.max(
                          ...decileData.map((entry) => {
                            const beforeTaxIncome = entry.averageTaxableIncome;
                            const beforeTaxPlusUbi = beforeTaxIncome + ubiAmountInThousands;
                            const afterTaxOld = taxCalculator.calculateIncomeWithUBI(beforeTaxIncome);
                            const afterTaxNew = taxCalculator.calculateAfterTaxIncomeNew(beforeTaxIncome);

                            return Math.max(beforeTaxPlusUbi, afterTaxOld, afterTaxNew);
                          })
                        );
                        
                        const yMax = Math.ceil(maxIncome / 50) * 50;
                        
                        addDebug(`Max Income: $${maxIncome}k`, 'info');
                        addDebug(`Y-axis Max: $${yMax}k`, 'info');
                        
                        // Check a few sample calculations
                        addDebug('<strong>Sample Calculations:</strong>', 'info');
                        decileData.slice(0, 3).forEach((entry, index) => {
                            const beforeTaxIncome = entry.averageTaxableIncome;
                            const beforeTaxPlusUbi = beforeTaxIncome + ubiAmountInThousands;
                            const afterTaxOld = taxCalculator.calculateIncomeWithUBI(beforeTaxIncome);
                            const afterTaxNew = taxCalculator.calculateAfterTaxIncomeNew(beforeTaxIncome);
                            
                            addDebug(`Decile ${entry.decile}:`, 'info');
                            addDebug(`  - Before-tax: $${beforeTaxIncome}k`, 'info');
                            addDebug(`  - Before-tax + UBI: $${beforeTaxPlusUbi}k`, 'info');
                            addDebug(`  - After-tax (old): $${Math.round(afterTaxOld)}k`, 'info');
                            addDebug(`  - After-tax (new): $${Math.round(afterTaxNew)}k`, 'info');
                        });
                        
                        // Check the chart dimensions
                        const incomeChart = iframeDoc.getElementById('incomeChart');
                        if (incomeChart) {
                            const viewBox = incomeChart.getAttribute('viewBox');
                            addDebug(`Chart viewBox: ${viewBox}`, 'info');
                            
                            // Check if ChartBuilder dimensions are correct
                            if (iframeWindow.incomeChartBuilder) {
                                const dimensions = iframeWindow.incomeChartBuilder.getDimensions();
                                addDebug(`Chart dimensions: ${dimensions.width} x ${dimensions.height}`, 'info');
                                
                                const yScale = dimensions.height / yMax;
                                addDebug(`Y-scale factor: ${yScale} (pixels per thousand)`, 'info');
                                
                                // Check a sample bar height
                                const sampleIncome = decileData[0].averageTaxableIncome;
                                const sampleHeight = sampleIncome * yScale;
                                addDebug(`Sample: $${sampleIncome}k should be ${sampleHeight}px tall`, 'info');
                            }
                            
                            // Check actual bar heights in the DOM
                            const bars = incomeChart.querySelectorAll('rect');
                            if (bars.length > 0) {
                                addDebug(`Found ${bars.length} bars in chart`, 'success');
                                
                                // Check first few bars
                                Array.from(bars).slice(0, 6).forEach((bar, index) => {
                                    const height = bar.getAttribute('height');
                                    const y = bar.getAttribute('y');
                                    const className = bar.getAttribute('class');
                                    addDebug(`Bar ${index}: height=${height}px, y=${y}px, class=${className}`, 'info');
                                });
                            } else {
                                addDebug('No bars found in chart!', 'error');
                            }
                            
                            // Check Y-axis labels
                            const yLabels = incomeChart.querySelectorAll('text');
                            const yAxisLabels = Array.from(yLabels).filter(label => 
                                label.textContent.includes('$') && label.textContent.includes('k')
                            );
                            if (yAxisLabels.length > 0) {
                                addDebug('Y-axis labels found:', 'success');
                                yAxisLabels.forEach(label => {
                                    addDebug(`  - ${label.textContent} at y=${label.getAttribute('y')}`, 'info');
                                });
                            }
                        }
                        
                    } else {
                        addDebug('Cannot access chart data or parameter manager', 'error');
                    }
                    
                } catch (e) {
                    addDebug(`Error: ${e.message}`, 'error');
                }
            }, 3000);
        });
    </script>
</body>
</html>
