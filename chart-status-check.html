<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Status Check</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .working { background: #d4edda; color: #155724; }
        .broken { background: #f8d7da; color: #721c24; }
        .partial { background: #fff3cd; color: #856404; }
        iframe { width: 100%; height: 600px; border: 2px solid #007bff; margin: 10px 0; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-item { border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Chart Status Check</h1>
    
    <div id="overall-status"></div>
    
    <div class="test-grid">
        <div class="test-item">
            <h3>Direct Chart Access</h3>
            <iframe id="direct-chart" src="/decile-calculator-svg-demo.html?ubiAmount=24&taxPercentage=30&exemptionAmount=24"></iframe>
            <div id="direct-status">Loading...</div>
        </div>
        
        <div class="test-item">
            <h3>Standalone App</h3>
            <iframe id="standalone-app" src="/standalone-app.html"></iframe>
            <div id="standalone-status">Loading...</div>
        </div>
    </div>
    
    <div id="detailed-results"></div>
    
    <script>
        const overallStatus = document.getElementById('overall-status');
        const directStatus = document.getElementById('direct-status');
        const standaloneStatus = document.getElementById('standalone-status');
        const detailedResults = document.getElementById('detailed-results');
        const directChart = document.getElementById('direct-chart');
        const standaloneApp = document.getElementById('standalone-app');
        
        let directWorking = false;
        let standaloneWorking = false;
        let testResults = [];
        
        function addResult(message) {
            testResults.push(message);
            updateDetailedResults();
        }
        
        function updateDetailedResults() {
            detailedResults.innerHTML = '<h3>Detailed Test Results:</h3>' + 
                testResults.map(result => `<div>${result}</div>`).join('');
        }
        
        function updateOverallStatus() {
            if (directWorking && standaloneWorking) {
                overallStatus.className = 'status working';
                overallStatus.innerHTML = '<h2>✅ CHARTS ARE WORKING</h2><p>Both direct chart and standalone app are functional. Safe to continue with more refactoring.</p>';
            } else if (directWorking || standaloneWorking) {
                overallStatus.className = 'status partial';
                overallStatus.innerHTML = '<h2>⚠️ PARTIAL FUNCTIONALITY</h2><p>Some charts working, some not. Should fix issues before more refactoring.</p>';
            } else {
                overallStatus.className = 'status broken';
                overallStatus.innerHTML = '<h2>❌ CHARTS NOT WORKING</h2><p>Charts appear broken. Should fix before continuing refactoring.</p>';
            }
        }
        
        // Test direct chart
        directChart.addEventListener('load', () => {
            setTimeout(() => {
                try {
                    const iframeDoc = directChart.contentDocument;
                    const incomeChart = iframeDoc.getElementById('incomeChart');
                    
                    if (incomeChart) {
                        const rects = incomeChart.querySelectorAll('rect');
                        const incomeBars = incomeChart.querySelectorAll('.income-bar');
                        const ubiBars = incomeChart.querySelectorAll('.ubi-bar');
                        const afterTaxNewBars = incomeChart.querySelectorAll('.after-tax-new-bar');
                        
                        if (rects.length >= 30 && incomeBars.length === 10 && ubiBars.length === 10 && afterTaxNewBars.length === 10) {
                            directWorking = true;
                            directStatus.className = 'status working';
                            directStatus.textContent = '✅ Direct chart working perfectly';
                            addResult('✅ Direct chart: Multi-bar structure working correctly');
                        } else {
                            directStatus.className = 'status partial';
                            directStatus.textContent = `⚠️ Direct chart partially working (${rects.length} bars total)`;
                            addResult(`⚠️ Direct chart: Found ${rects.length} bars, ${incomeBars.length} income, ${ubiBars.length} UBI, ${afterTaxNewBars.length} new`);
                        }
                    } else {
                        directStatus.className = 'status broken';
                        directStatus.textContent = '❌ Direct chart not rendering';
                        addResult('❌ Direct chart: No chart element found');
                    }
                } catch (e) {
                    directStatus.className = 'status broken';
                    directStatus.textContent = `❌ Direct chart error: ${e.message}`;
                    addResult(`❌ Direct chart error: ${e.message}`);
                }
                updateOverallStatus();
            }, 3000);
        });
        
        // Test standalone app
        standaloneApp.addEventListener('load', () => {
            setTimeout(() => {
                try {
                    const iframeDoc = standaloneApp.contentDocument;
                    const decileIframe = iframeDoc.getElementById('decileIframe');
                    
                    if (decileIframe) {
                        // Wait for nested iframe to load
                        setTimeout(() => {
                            try {
                                const nestedDoc = decileIframe.contentDocument;
                                const incomeChart = nestedDoc.getElementById('incomeChart');
                                
                                if (incomeChart) {
                                    const rects = incomeChart.querySelectorAll('rect');
                                    if (rects.length >= 30) {
                                        standaloneWorking = true;
                                        standaloneStatus.className = 'status working';
                                        standaloneStatus.textContent = '✅ Standalone app working';
                                        addResult('✅ Standalone app: Chart rendering correctly');
                                    } else {
                                        standaloneStatus.className = 'status partial';
                                        standaloneStatus.textContent = `⚠️ Standalone app partially working (${rects.length} bars)`;
                                        addResult(`⚠️ Standalone app: Only ${rects.length} bars found`);
                                    }
                                } else {
                                    standaloneStatus.className = 'status broken';
                                    standaloneStatus.textContent = '❌ Standalone app chart not found';
                                    addResult('❌ Standalone app: No chart in nested iframe');
                                }
                            } catch (e) {
                                standaloneStatus.className = 'status broken';
                                standaloneStatus.textContent = `❌ Standalone nested error: ${e.message}`;
                                addResult(`❌ Standalone nested error: ${e.message}`);
                            }
                            updateOverallStatus();
                        }, 2000);
                    } else {
                        standaloneStatus.className = 'status broken';
                        standaloneStatus.textContent = '❌ Standalone app iframe not found';
                        addResult('❌ Standalone app: No decile iframe found');
                        updateOverallStatus();
                    }
                } catch (e) {
                    standaloneStatus.className = 'status broken';
                    standaloneStatus.textContent = `❌ Standalone app error: ${e.message}`;
                    addResult(`❌ Standalone app error: ${e.message}`);
                    updateOverallStatus();
                }
            }, 2000);
        });
        
        // Timeout fallback
        setTimeout(() => {
            if (!directWorking && !standaloneWorking) {
                updateOverallStatus();
            }
        }, 10000);
    </script>
</body>
</html>
